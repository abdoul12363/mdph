<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recours MDPH — Accompagnement spécialisé</title>
  <meta name="description" content="Accompagnement pour contester une décision MDPH (RAPO ou Tribunal administratif)" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Heebo:400,700|IBM+Plex+Sans:600" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="/src/css/styles.css" />
  <link rel="stylesheet" href="/src/css/form.css" />
  <link rel="stylesheet" href="/src/css/recours.css" />
  <style>
    .recours-step.hidden { display: none; }
  </style>
</head>
<body class="form-page">
  <header class="header">
    <div class="container header-inner">
      <div class="brand"></div>
      <nav class="nav">
        <a class="nav-link" href="/">Accueil</a>
        <a class="nav-link" href="/donnees-confidentialite.html">Données & confidentialité</a>
        <a class="nav-link" href="/qui-sommes-nous.html">Qui sommes-nous</a>
        <span class="nav-phone">02 99 260 127</span>
      </nav>
    </div>
  </header>

  <main class="main">
    <section class="section">
      <div class="container">
        <div class="card form-card">
          
          <div id="step2" class="recours-step">
            <div id="questionArea"></div>
            <div class="form-actions">
              <button class="btn" id="prevBtn" type="button" disabled>Précédent</button>
              <button class="btn btn-primary" id="nextBtn" type="button">Suivant</button>
            </div>
          </div>

          <div id="step3" class="recours-step hidden">
            <h2>Accompagnement pour votre recours</h2>
            <p>Votre situation nécessite un accompagnement spécialisé pour maximiser vos chances de succès.</p>
            
            <div class="pricing-offer">
              <div class="pricing-price">49,90 €</div>
              <div class="pricing-title">Offre Recours MDPH – Accompagnement complet</div>
              <ul class="pricing-features">
                <li>Analyse approfondie de votre dossier – Étude de la décision MDPH et des éléments de votre situation</li>
                <li>Structuration du recours – Préparation du RAPO ou du recours contentieux selon votre situation</li>
                <li>Préparation des arguments juridiques – Construction d'une argumentation solide et adaptée</li>
                <li>Accompagnement personnalisé – Échange avec un expert MDPH pour finaliser votre recours</li>
                <li>Documents structurés – Recours rédigé et prêt à envoyer</li>
              </ul>
              <p class="muted">Paiement sécurisé – Accès immédiat après validation</p>
            </div>

            <div class="form-actions">
              <button class="btn" id="btn-back-step3" type="button">Retour</button>
              <button class="btn btn-primary" id="btn-step3" type="button">Procéder au paiement</button>
            </div>
          </div>

        </div>
        <p class="muted" id="status"></p>
      </div>
    </section>
  </main>

  <script type="module">
    import { responses, saveLocal, loadSaved } from '/src/js/modules/storage.js';
 
    // Fonction d'initialisation comme dans form.js
    async function boot() {
      loadSaved();

      // Charger le JSON de questions (fallback si erreur)
      recoursQuestions = await loadRecoursQuestions();

      // Si le JSON ne charge pas, bloquer l'étape 2 (pas de questions hardcodées)
      if (!Array.isArray(recoursQuestions) || recoursQuestions.length === 0) {
        const status = document.getElementById('status');
        if (status) {
          status.textContent = 'Erreur de chargement des questions du recours. Veuillez réessayer plus tard.';
        }
        return;
      }

      // Restaurer l'étape et l'index de question après refresh
      const savedStep = Number(responses.recours_step || 2);
      const savedIndex = Number.isFinite(Number(responses.recours_question_index))
        ? Number(responses.recours_question_index)
        : 0;
      currentQuestionIndex = Math.max(0, savedIndex);

      if (savedStep >= 3) {
        showStep(3);
      } else {
        initStep2();
        showStep(2);
      }
    }

    let recoursQuestions = [];

    async function loadRecoursQuestions() {
      try {
        const res = await fetch('/data/pages/recours/recours.json', { cache: 'no-store' });
        if (!res.ok) return [];
        const data = await res.json();
        if (!data || !Array.isArray(data.questions) || data.questions.length === 0) return [];
        return data.questions;
      } catch {
        return [];
      }
    }

    let currentQuestionIndex = 0;

    // Fonction pour rendre une question
    function renderRecoursQuestion(question) {
      const questionArea = document.getElementById('questionArea');
      
      let html = `
        <div class="question-item">
          <div class="q-title">${question.title}</div>
          <div class="field-container">
      `;
      
      if (question.type === 'textarea') {
        html += `
          <label for="${question.id}">${question.description}</label>
          <textarea id="${question.id}" 
                   required 
                   minlength="${question.minLength || ''}" 
                   maxlength="${question.maxLength || ''}"
                   placeholder="${question.placeholder || ''}"></textarea>
          <div class="char-counter" id="counter-${question.id}">
            <span class="char-count">0</span> / ${question.maxLength} caractères
            <span class="char-min">(minimum ${question.minLength})</span>
          </div>
        `;
      } else if (question.type === 'date') {
        html += `
          <label for="${question.id}">${question.description}</label>
          <input type="date" id="${question.id}" required />
        `;
      } else if (question.type === 'checkbox') {
        html += `
          <label>${question.description}</label>
          <div class="choice-grid">
        `;
        question.options.forEach(option => {
          html += `
            <label class="choice">
              <input type="checkbox" name="${question.id}" value="${option.value}" />
              <span>${option.label}</span>
            </label>
          `;
        });
        html += `
          </div>
        `;
      } else if (question.type === 'checkbox_single') {
        html += `
          <div class="choice-grid">
            <label class="choice terms-choice" style="cursor: pointer;">
              <input type="checkbox" id="${question.id}" required />
              <span class="terms-text">${question.checkboxLabel}</span>
            </label>
          </div>
        `;
      } else if (question.type === 'radio') {
        html += `
          <label>${question.description}</label>
          <div class="choice-grid">
        `;
        question.options.forEach(option => {
          html += `
            <label class="choice">
              <input type="radio" name="${question.id}" value="${option.value}" required />
              <span>${option.label}</span>
            </label>
          `;
        });
        html += `
          </div>
        `;
      }
      
      html += `
          </div>
        </div>
      `;
      
      questionArea.innerHTML = html;
      
      // Initialiser les compteurs de caractères
      if (question.type === 'textarea') {
        initCharCounter(question.id, question.minLength, question.maxLength);
      }

      // Brancher les listeners (pas d'inline handlers en module)
      if (question.type === 'date') {
        const el = document.getElementById(question.id);
        if (el) {
          el.addEventListener('change', () => {
            responses[question.id] = el.value;
            saveLocal(true);
          });
        }
      }
      if (question.type === 'checkbox') {
        const inputs = document.querySelectorAll(`input[name="${question.id}"]`);
        inputs.forEach((input) => {
          input.addEventListener('change', () => updateCheckboxResponse(question.id));
        });
      }
      if (question.type === 'checkbox_single') {
        const checkbox = document.getElementById(question.id);
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            responses[question.id] = checkbox.checked;
            saveLocal(true);
          });
        }

        const links = document.querySelectorAll('.terms-choice a');
        links.forEach((a) => {
          a.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        });
      }
      if (question.type === 'radio') {
        const radios = document.querySelectorAll(`input[name="${question.id}"]`);
        radios.forEach((radio) => {
          radio.addEventListener('change', () => {
            responses[question.id] = radio.value;
            saveLocal(true);
          });
        });
      }
      
      // Charger les valeurs sauvegardées
      loadQuestionValues(question);
    }

    // Initialiser un compteur de caractères
    function initCharCounter(textareaId, minLength, maxLength) {
      const textarea = document.getElementById(textareaId);
      const counter = document.getElementById(`counter-${textareaId}`);
      const charCount = counter.querySelector('.char-count');
      
      function updateCounter() {
        const currentLength = textarea.value.length;
        charCount.textContent = currentLength;
        
        counter.classList.remove('char-counter--too-short', 'char-counter--valid', 'char-counter--too-long');
        
        if (currentLength < minLength) {
          counter.classList.add('char-counter--too-short');
        } else if (currentLength > maxLength) {
          counter.classList.add('char-counter--too-long');
        } else {
          counter.classList.add('char-counter--valid');
        }
        
        responses[textareaId] = textarea.value;
        saveLocal(true);
      }
      
      textarea.addEventListener('input', updateCounter);
      updateCounter(); // Initialiser
    }

    // Charger les valeurs sauvegardées pour une question
    function loadQuestionValues(question) {
      if (question.type === 'textarea' || question.type === 'date') {
        if (responses[question.id]) {
          document.getElementById(question.id).value = responses[question.id];
          // Initialiser le compteur de caractères pour les textarea
          if (question.type === 'textarea') {
            const counter = document.getElementById(`counter-${question.id}`);
            if (counter) {
              const charCount = counter.querySelector('.char-count');
              const currentLength = responses[question.id].length;
              charCount.textContent = currentLength;
              
              // Mettre à jour les classes de couleur
              counter.classList.remove('char-counter--too-short', 'char-counter--valid', 'char-counter--too-long');
              if (currentLength < question.minLength) {
                counter.classList.add('char-counter--too-short');
              } else if (currentLength > question.maxLength) {
                counter.classList.add('char-counter--too-long');
              } else {
                counter.classList.add('char-counter--valid');
              }
            }
          }
        }
      } else if (question.type === 'checkbox' && Array.isArray(responses[question.id])) {
        responses[question.id].forEach(value => {
          const checkbox = document.querySelector(`input[name="${question.id}"][value="${value}"]`);
          if (checkbox) checkbox.checked = true;
        });
      } else if (question.type === 'checkbox_single') {
        const checkbox = document.getElementById(question.id);
        if (checkbox && responses[question.id]) {
          checkbox.checked = true;
        }
      } else if (question.type === 'radio' && responses[question.id]) {
        const radio = document.querySelector(`input[name="${question.id}"][value="${responses[question.id]}"]`);
        if (radio) radio.checked = true;
      }
    }

    // Afficher la question actuelle
    function showCurrentQuestion() {
      if (currentQuestionIndex < recoursQuestions.length) {
        renderRecoursQuestion(recoursQuestions[currentQuestionIndex]);
        updateButtonStates();
        
        // Nettoyer les messages d'erreur
        const status = document.getElementById('status');
        if (status) status.textContent = '';
      }
    }

    // Mettre à jour les réponses checkbox automatiquement
    function updateCheckboxResponse(questionId) {
      const checked = document.querySelectorAll(`input[name="${questionId}"]:checked`);
      responses[questionId] = Array.from(checked).map(cb => cb.value);
      saveLocal(true);
    }

    // Initialiser l'étape 2
    function initStep2() {
      if (!Number.isFinite(currentQuestionIndex) || currentQuestionIndex < 0) currentQuestionIndex = 0;
      if (currentQuestionIndex >= recoursQuestions.length) currentQuestionIndex = Math.max(0, recoursQuestions.length - 1);
      showCurrentQuestion();
    }

    // Navigation dans les questions
    document.getElementById('nextBtn').addEventListener('click', function() {
      // Valider la question actuelle
      const currentQuestion = recoursQuestions[currentQuestionIndex];
      let isValid = true;
      
      if (currentQuestion.type === 'textarea' || currentQuestion.type === 'date') {
        const value = document.getElementById(currentQuestion.id).value;
        if (!value || (currentQuestion.minLength && value.length < currentQuestion.minLength)) {
          isValid = false;
        } else {
          responses[currentQuestion.id] = value;
          saveLocal(true);
        }
      } else if (currentQuestion.type === 'checkbox') {
        const checked = document.querySelectorAll(`input[name="${currentQuestion.id}"]:checked`);
        if (checked.length === 0) {
          isValid = false;
        } else {
          responses[currentQuestion.id] = Array.from(checked).map(cb => cb.value);
          saveLocal(true);
        }
      } else if (currentQuestion.type === 'checkbox_single') {
        const checkbox = document.getElementById(currentQuestion.id);
        if (!checkbox || !checkbox.checked) {
          isValid = false;
        } else {
          responses[currentQuestion.id] = true;
          saveLocal(true);
        }
      } else if (currentQuestion.type === 'radio') {
        const selected = document.querySelector(`input[name="${currentQuestion.id}"]:checked`);
        if (!selected) {
          isValid = false;
        } else {
          responses[currentQuestion.id] = selected.value;
          saveLocal(true);
        }
      }
      
      if (!isValid) {
        const status = document.getElementById('status');
        if (status) status.textContent = 'Veuillez remplir tous les champs obligatoires';
        return;
      }
      
      // Passer à la question suivante ou à l'étape 3
      currentQuestionIndex++;
      responses.recours_question_index = currentQuestionIndex;
      saveLocal(true);
      if (currentQuestionIndex < recoursQuestions.length) {
        showCurrentQuestion();
        updateButtonStates();
      } else {
        showStep(3); // Passer à l'offre
      }
    });

    document.getElementById('prevBtn').addEventListener('click', function() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        responses.recours_question_index = currentQuestionIndex;
        saveLocal(true);
        showCurrentQuestion();
        updateButtonStates();
      }
    });

    // Mettre à jour l'état des boutons
    function updateButtonStates() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (prevBtn) {
        prevBtn.disabled = currentQuestionIndex === 0; // Désactivé à la première question
      }
      
      if (nextBtn) {
        nextBtn.disabled = false;
      }
    }

    document.getElementById('btn-back-step3').addEventListener('click', function() {
      currentQuestionIndex = recoursQuestions.length - 1; // Revenir à la dernière question
      showCurrentQuestion();
      showStep(2);
    });

    document.getElementById('btn-step3').addEventListener('click', function() {
      // Rediriger vers le paiement
      window.location.href = '/paiement?offer=recours';
    });

    // Fonctions utilitaires pour afficher/masquer les étapes
    function showStep(stepNumber) {
      document.querySelectorAll('.recours-step').forEach(step => {
        step.classList.add('hidden');
      });
      document.getElementById(`step${stepNumber}`).classList.remove('hidden');

      responses.recours_step = stepNumber;
      saveLocal(true);
      
      // Nettoyer les messages d'erreur
      const status = document.getElementById('status');
      if (status) status.textContent = '';
      
      window.scrollTo(0, 0);
    }

    // Démarrer l'application
    boot();
  </script>
</body>
</html>
